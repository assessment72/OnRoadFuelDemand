name: Android CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: โ ูุญุต ุงูููุฏ ูู ุงููุณุชูุฏุน
        uses: actions/checkout@v4

      - name: ๐ง ุฅุนุฏุงุฏ JDK (ุฃุญุฏุซ ุฅุตุฏุงุฑ ูุชุงุญ)
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: gradle

      - name: ๐ฑ ุฅุนุฏุงุฏ ุจูุฆุฉ Android SDK (ุฃุญุฏุซ ุฅุตุฏุงุฑ)
        uses: android-actions/setup-android@v2
        with:
          cmdline-tools-version: latest
          build-tools-version: latest
          platform-version: latest
          ndk-version: latest

      - name: ๐๏ธ ุฅูุดุงุก ููู local.properties ูู ุฌุฐุฑ ุงููุดุฑูุน
        run: echo "sdk.dir=/usr/local/lib/android/sdk" > $GITHUB_WORKSPACE/local.properties

      - name: ๐๏ธ ุชุญุฏูุซ Gradle ุชููุงุฆููุง
        run: |
          LATEST_GRADLE_URL=$(curl -s https://services.gradle.org/versions/current | jq -r '.downloadUrl')
          if [ -z "$LATEST_GRADLE_URL" ]; then
            echo "โ๏ธ ูุดู ุชุญุฏูุฏ ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู Gradleุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุฅุตุฏุงุฑ ุงููุซุจุช."
          else
            wget $LATEST_GRADLE_URL -O gradle-latest.zip || echo "โ๏ธ ูุดู ุชุญููู Gradleุ ูุชู ุงุณุชุฎุฏุงู ุงูุฅุตุฏุงุฑ ุงูุญุงูู."
            unzip -qo gradle-latest.zip -d /opt/ || echo "โ๏ธ ูุดู ูู ุงูุถุบุทุ ูุฏ ูููู ุงูููู ุบูุฑ ูุชุงุญ."
            echo "export PATH=/opt/gradle/bin:$PATH" >> $GITHUB_ENV
          fi

      - name: ๐ ููุญ ุงูุฃุฐููุงุช ูู gradlew
        run: chmod +x gradlew

      - name: ๐ ุชุฎุฒูู ุงูุชุจุนูุงุช ูุชุญุณูู ุงูุฃุฏุงุก
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/*.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ๐ ูุญุต ุงูุชุจุนูุงุช ูุชุญุฏูุซูุง ุชููุงุฆููุง
        run: |
          ./gradlew dependencies || echo "โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุชุจุนูุงุชุ ูุชู ุงูุชุฌุงูู ููุชุงุจุนุฉ ุงูุจูุงุก."
          ./gradlew buildSrcVersions --update || echo "โ๏ธ ูุดู ุชุญุฏูุซ ุงูุชุจุนูุงุชุ ูุชู ูุชุงุจุนุฉ ุงูุจูุงุก ุฏูู ุชุญุฏูุซ."

      - name: ๐๏ธ ุชุดุบูู ุงูุจูุงุก ูุน ุชุญููู ุงูุฃุฎุทุงุก
        run: |
          ./gradlew assembleDebug --stacktrace --no-daemon || (./gradlew clean && ./gradlew assembleDebug)
        continue-on-error: true

      - name: ๐ ุงุณุชุฎุฑุงุฌ ุฑุณุงูุฉ ุงูุฎุทุฃ ูุชุญููููุง ุชููุงุฆููุง
        run: |
          ERROR_MESSAGE=$(grep -i "FAILURE" build.log || echo "No errors detected.")
          echo "๐ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูููุชุดูุฉ: $ERROR_MESSAGE"

          if echo "$ERROR_MESSAGE" | grep -q "Task 'buildSrcVersions' not found"; then
            echo "๐๏ธ ุชุตุญูุญ ุงูุฎุทุฃ: ุณูุชู ุชุฌุงูู ูุฐู ุงููููุฉ."
            sed -i '/buildSrcVersions/d' build.gradle
            ./gradlew clean && ./gradlew assembleDebug
          fi

          if echo "$ERROR_MESSAGE" | grep -q "dependency conflict"; then
            echo "๐ ุชุญุฏูุซ ุงูุชุจุนูุงุช ูุญู ุงูุชุนุงุฑุถุงุช..."
            ./gradlew dependencies --refresh-dependencies
            ./gradlew clean && ./gradlew assembleDebug
          fi

      - name: ๐ ุญูุธ ุณุฌู ุงูุฃุฎุทุงุก
        run: ./gradlew build --stacktrace > build.log || echo "โ๏ธ ูุดู ุงูุจูุงุกุ ุฑุงุฌุน build.log"

      - name: ๐ค ุฑูุน ุณุฌู ุงูุฃุฎุทุงุก
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

      - name: ๐ค ุฑูุน ููู APK ุจุนุฏ ูุฌุงุญ ุงูุจูุงุก
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 1

      - name: โ๏ธ ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุงููุดู
        if: failure()
        run: echo "โ๏ธ ูุดู ุงูุจูุงุกุ ูุฑุฌู ุงูุชุญูู ูู ุงูุณุฌู ุฃู ุฅุตูุงุญ ุงูุฃุฎุทุงุก ุชููุงุฆููุง."

      - name: ๐งน ุชูุธูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุจุนุฏ ุงูุชูููุฐ
        run: rm -rf ~/.gradle/caches
